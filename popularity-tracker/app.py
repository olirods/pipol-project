import os
from flask import Flask
import requests
import xml.etree.ElementTree as ET
from names_dataset import NameDataset
from pytrends.request import TrendReq
from dotenv import load_dotenv
from openai import OpenAI
import json
from serpapi import GoogleSearch


load_dotenv()

app = Flask(__name__)
ai_client = OpenAI(api_key=os.environ.get("OPENAI_API_KEY"))
pytrends = TrendReq(hl="es")


@app.route("/people/ranking")
def get_people_ranking():
    url = "https://trends.google.es/trends/trendingsearches/daily/rss?geo=ES"

    response = requests.get(url)

    if response.status_code == 200:
        root = ET.fromstring(response.content)

        namespace = {
            "atom": "http://www.w3.org/2005/Atom",
            "ht": "https://trends.google.es/trends/trendingsearches/daily",
        }

        topics = root.findall(".//channel/item", namespace)

        topics_info = []
        for topic in topics:
            title_element = topic.find("title", namespace)
            if title_element is not None:
                person_name = title_element.text
                news_item = topic.find(".//ht:news_item", namespace)
                if news_item is not None:
                    news_title = news_item.find("ht:news_item_title", namespace).text
                    news_snippet = news_item.find(
                        "ht:news_item_snippet", namespace
                    ).text
                    topics_info.append(
                        {
                            "name": person_name,
                            "news_title": news_title,
                            "news_snippet": news_snippet,
                        }
                    )

        return filter_and_summarize(topics_info)
    else:
        return "Failed to retrieve info!!!!"


def filter_and_summarize(topics_info):
    completion1 = ai_client.chat.completions.create(
        model="gpt-3.5-turbo-0125",
        response_format={"type": "json_object"},
        messages=[
            {
                "role": "system",
                "content": 'El usuario te va a pasar un array de términos que son tendencia ahora mismo en España, cada término será un objeto JSON que tiene name (término), news_snippet y news_title (información de noticias de por qué es tendencia). Necesito que me devuelvas la lista quitando aquellos términos que no correspondan a personas o famosos (ejemplo: "name": “Juana Pérez alcaldesa”, "name": "Antonio", "name": "Mourinho" o "name": “Morat" sí, pero "name": “Real Madrid” o "name": "Eurovisión" no), basándote en el término en sí pero también el contexto que te da la información de noticias. El formato tiene que ser algo así: {"result": [“Aitana”, "Zapatero presidente", "Morat", "Juan Rodríguez"]}',
            },
            {"role": "user", "content": json.dumps(topics_info)},
        ],
    )

    response1 = json.loads(completion1.choices[0].message.content)

    people = response1["result"]

    people_info = list(filter(lambda x: x["name"] in people, topics_info))

    completion2 = ai_client.chat.completions.create(
        model="gpt-3.5-turbo-0125",
        response_format={"type": "json_object"},
        messages=[
            {
                "role": "system",
                "content": 'El usuario te va a pasar un array de personas o famosos que son tendencia ahora mismo en España, cada elemento de la lista será un objeto JSON que tiene name, news_snippet y news_title (información de noticias de por qué es tendencia). Necesito que me generes un objeto JSON con el nombre y un texto que explique por qué esa persona está en tendencia ahora mismo, basándote en la información que te provee news_snippet y news_title, y tu sentido común. El formato tiene que ser algo así: {"result": [{“name”: “Aitana”, “why”: “Se la ha visto recientemente con su expareja, el cantante Sebastián Yatra, meses después de su ruptura. Ella no ha hecho declaraciones. Además, saca una nueva canción en las próximas semanas, Este single es la primera muestra de que sería su tercer trabajo discográfico”}, {“name”: "Zapatero presidente", “why”: “Ha anunciado recientemente que se va a presentar a las primarias del PSOE para ser el candidato del partido a las elecciones generales, con intención de convertirse de nuevo en presidente del gobierno. Está recibiendo mucho apoyo de los militantes y está el primero en las encuestas.”}]}',
            },
            {"role": "user", "content": json.dumps(people_info)},
        ],
    )

    response2 = json.loads(completion2.choices[0].message.content)

    return response2["result"]


@app.route("/people/<person>/history")
def get_person_history(person):
    if person == "Carolina Marin":
        return {
            "1563062400000": 5,
            "1563667200000": 2,
            "1564272000000": 4,
            "1564876800000": 4,
            "1565481600000": 2,
            "1566086400000": 5,
            "1566691200000": 7,
            "1567296000000": 3,
            "1567900800000": 8,
            "1568505600000": 34,
            "1569110400000": 45,
            "1569715200000": 5,
            "1570320000000": 6,
            "1570924800000": 15,
            "1571529600000": 25,
            "1572134400000": 35,
            "1572739200000": 7,
            "1573344000000": 4,
            "1573948800000": 5,
            "1574553600000": 8,
            "1575158400000": 19,
            "1575763200000": 6,
            "1576368000000": 8,
            "1576972800000": 4,
            "1577577600000": 4,
            "1578182400000": 13,
            "1578787200000": 16,
            "1579392000000": 32,
            "1579996800000": 9,
            "1580601600000": 6,
            "1581206400000": 9,
            "1581811200000": 21,
            "1582416000000": 20,
            "1583020800000": 13,
            "1583625600000": 25,
            "1584230400000": 28,
            "1584835200000": 20,
            "1585440000000": 9,
            "1586044800000": 7,
            "1586649600000": 9,
            "1587254400000": 8,
            "1587859200000": 7,
            "1588464000000": 11,
            "1589068800000": 10,
            "1589673600000": 8,
            "1590278400000": 7,
            "1590883200000": 5,
            "1591488000000": 4,
            "1592092800000": 7,
            "1592697600000": 4,
            "1593302400000": 3,
            "1593907200000": 3,
            "1594512000000": 2,
            "1595116800000": 4,
            "1595721600000": 41,
            "1596326400000": 1,
            "1596931200000": 0,
            "1597536000000": 3,
            "1598140800000": 2,
            "1598745600000": 3,
            "1599350400000": 3,
            "1599955200000": 2,
            "1600560000000": 3,
            "1601164800000": 2,
            "1601769600000": 12,
            "1602374400000": 37,
            "1602979200000": 40,
            "1603584000000": 13,
            "1604188800000": 11,
            "1604793600000": 10,
            "1605398400000": 11,
            "1606003200000": 7,
            "1606608000000": 7,
            "1607212800000": 6,
            "1607817600000": 7,
            "1608422400000": 4,
            "1609027200000": 5,
            "1609632000000": 5,
            "1610236800000": 21,
            "1610841600000": 63,
            "1611446400000": 100,
            "1612051200000": 67,
            "1612656000000": 10,
            "1613260800000": 11,
            "1613865600000": 9,
            "1614470400000": 24,
            "1615075200000": 38,
            "1615680000000": 8,
            "1616284800000": 4,
            "1616889600000": 4,
            "1617494400000": 4,
            "1618099200000": 7,
            "1618704000000": 5,
            "1619308800000": 22,
            "1619913600000": 33,
            "1620518400000": 6,
            "1621123200000": 7,
            "1621728000000": 17,
            "1622332800000": 43,
            "1622937600000": 9,
            "1623542400000": 6,
            "1624147200000": 4,
            "1624752000000": 7,
            "1625356800000": 24,
            "1625961600000": 15,
            "1626566400000": 21,
            "1627171200000": 22,
            "1627776000000": 20,
            "1628380800000": 6,
            "1628985600000": 3,
            "1629590400000": 4,
            "1630195200000": 4,
            "1630800000000": 3,
            "1631404800000": 3,
            "1632009600000": 4,
            "1632614400000": 4,
            "1633219200000": 5,
            "1633824000000": 3,
            "1634428800000": 0,
            "1635033600000": 5,
            "1635638400000": 5,
            "1636243200000": 5,
            "1636848000000": 6,
            "1637452800000": 8,
            "1638057600000": 8,
            "1638662400000": 11,
            "1639267200000": 6,
            "1639872000000": 4,
            "1640476800000": 3,
            "1641081600000": 3,
            "1641686400000": 4,
            "1642291200000": 4,
            "1642896000000": 8,
            "1643500800000": 7,
            "1644105600000": 8,
            "1644710400000": 6,
            "1645315200000": 8,
            "1645920000000": 8,
            "1646524800000": 12,
            "1647129600000": 6,
            "1647734400000": 8,
            "1648339200000": 5,
            "1648944000000": 4,
            "1649548800000": 3,
            "1650153600000": 6,
            "1650758400000": 81,
            "1651363200000": 20,
            "1651968000000": 6,
            "1652572800000": 6,
            "1653177600000": 6,
            "1653782400000": 6,
            "1654387200000": 6,
            "1654992000000": 6,
            "1655596800000": 3,
            "1656201600000": 4,
            "1656806400000": 4,
            "1657411200000": 15,
            "1658016000000": 4,
            "1658620800000": 3,
            "1659225600000": 3,
            "1659830400000": 3,
            "1660435200000": 4,
            "1661040000000": 24,
            "1661644800000": 9,
            "1662249600000": 5,
            "1662854400000": 4,
            "1663459200000": 2,
            "1664064000000": 4,
            "1664668800000": 5,
            "1665273600000": 3,
            "1665878400000": 7,
            "1666483200000": 6,
            "1667088000000": 17,
            "1667692800000": 5,
            "1668297600000": 6,
            "1668902400000": 7,
            "1669507200000": 6,
            "1670112000000": 4,
            "1670716800000": 4,
            "1671321600000": 4,
            "1671926400000": 2,
            "1672531200000": 3,
            "1673136000000": 15,
            "1673740800000": 7,
            "1674345600000": 7,
            "1674950400000": 9,
            "1675555200000": 5,
            "1676160000000": 7,
            "1676764800000": 7,
            "1677369600000": 6,
            "1677974400000": 8,
            "1678579200000": 9,
            "1679184000000": 4,
            "1679788800000": 21,
            "1680393600000": 17,
            "1680998400000": 18,
            "1681603200000": 8,
            "1682208000000": 3,
            "1682812800000": 4,
            "1683417600000": 5,
            "1684022400000": 4,
            "1684627200000": 2,
            "1685232000000": 7,
            "1685836800000": 5,
            "1686441600000": 8,
            "1687046400000": 6,
            "1687651200000": 5,
            "1688256000000": 17,
            "1688860800000": 3,
            "1689465600000": 4,
            "1690070400000": 3,
            "1690675200000": 4,
            "1691280000000": 2,
            "1691884800000": 4,
            "1692489600000": 36,
            "1693094400000": 85,
            "1693699200000": 5,
            "1694304000000": 7,
            "1694908800000": 3,
            "1695513600000": 3,
            "1696118400000": 4,
            "1696723200000": 5,
            "1697328000000": 11,
            "1697932800000": 11,
            "1698537600000": 4,
            "1699142400000": 4,
            "1699747200000": 6,
            "1700352000000": 4,
            "1700956800000": 4,
            "1701561600000": 4,
            "1702166400000": 13,
            "1702771200000": 18,
            "1703376000000": 5,
            "1703980800000": 5,
            "1704585600000": 5,
            "1705190400000": 4,
            "1705795200000": 4,
            "1706400000000": 5,
            "1707004800000": 6,
            "1707609600000": 6,
            "1708214400000": 8,
            "1708819200000": 8,
            "1709424000000": 11,
            "1710028800000": 27,
            "1710633600000": 53,
            "1711238400000": 35,
            "1711843200000": 5,
            "1712448000000": 13,
            "1713052800000": 24,
            "1713657600000": 7,
            "1714262400000": 8,
            "1714867200000": 32,
            "1715472000000": 22,
            "1716076800000": 15,
            "1716681600000": 17,
            "1717286400000": 24,
            "1717891200000": 9,
            "1718496000000": 7,
            "1719100800000": 6,
            "1719705600000": 3,
            "1720310400000": 7,
            "1720915200000": 5,
        }
    elif person == "Donald Trump":
        return {
            "1563062400000": 3,
            "1563667200000": 2,
            "1564272000000": 2,
            "1564876800000": 2,
            "1565481600000": 2,
            "1566086400000": 3,
            "1566691200000": 3,
            "1567296000000": 2,
            "1567900800000": 2,
            "1568505600000": 2,
            "1569110400000": 3,
            "1569715200000": 2,
            "1570320000000": 2,
            "1570924800000": 2,
            "1571529600000": 2,
            "1572134400000": 2,
            "1572739200000": 2,
            "1573344000000": 2,
            "1573948800000": 2,
            "1574553600000": 2,
            "1575158400000": 2,
            "1575763200000": 2,
            "1576368000000": 3,
            "1576972800000": 2,
            "1577577600000": 4,
            "1578182400000": 9,
            "1578787200000": 3,
            "1579392000000": 2,
            "1579996800000": 2,
            "1580601600000": 3,
            "1581206400000": 2,
            "1581811200000": 2,
            "1582416000000": 2,
            "1583020800000": 2,
            "1583625600000": 3,
            "1584230400000": 3,
            "1584835200000": 4,
            "1585440000000": 5,
            "1586044800000": 4,
            "1586649600000": 4,
            "1587254400000": 7,
            "1587859200000": 5,
            "1588464000000": 3,
            "1589068800000": 3,
            "1589673600000": 4,
            "1590278400000": 4,
            "1590883200000": 28,
            "1591488000000": 6,
            "1592092800000": 6,
            "1592697600000": 4,
            "1593302400000": 4,
            "1593907200000": 3,
            "1594512000000": 3,
            "1595116800000": 3,
            "1595721600000": 3,
            "1596326400000": 3,
            "1596931200000": 3,
            "1597536000000": 8,
            "1598140800000": 9,
            "1598745600000": 3,
            "1599350400000": 4,
            "1599955200000": 3,
            "1600560000000": 3,
            "1601164800000": 17,
            "1601769600000": 16,
            "1602374400000": 4,
            "1602979200000": 4,
            "1603584000000": 5,
            "1604188800000": 46,
            "1604793600000": 17,
            "1605398400000": 5,
            "1606003200000": 6,
            "1606608000000": 3,
            "1607212800000": 3,
            "1607817600000": 3,
            "1608422400000": 6,
            "1609027200000": 3,
            "1609632000000": 11,
            "1610236800000": 6,
            "1610841600000": 9,
            "1611446400000": 3,
            "1612051200000": 2,
            "1612656000000": 2,
            "1613260800000": 2,
            "1613865600000": 1,
            "1614470400000": 1,
            "1615075200000": 1,
            "1615680000000": 1,
            "1616284800000": 1,
            "1616889600000": 1,
            "1617494400000": 1,
            "1618099200000": 2,
            "1618704000000": 1,
            "1619308800000": 1,
            "1619913600000": 1,
            "1620518400000": 1,
            "1621123200000": 1,
            "1621728000000": 1,
            "1622332800000": 1,
            "1622937600000": 1,
            "1623542400000": 1,
            "1624147200000": 1,
            "1624752000000": 1,
            "1625356800000": 1,
            "1625961600000": 1,
            "1626566400000": 1,
            "1627171200000": 1,
            "1627776000000": 1,
            "1628380800000": 1,
            "1628985600000": 1,
            "1629590400000": 1,
            "1630195200000": 1,
            "1630800000000": 1,
            "1631404800000": 1,
            "1632009600000": 1,
            "1632614400000": 1,
            "1633219200000": 1,
            "1633824000000": 1,
            "1634428800000": 1,
            "1635033600000": 1,
            "1635638400000": 1,
            "1636243200000": 1,
            "1636848000000": 1,
            "1637452800000": 1,
            "1638057600000": 1,
            "1638662400000": 1,
            "1639267200000": 1,
            "1639872000000": 1,
            "1640476800000": 1,
            "1641081600000": 1,
            "1641686400000": 1,
            "1642291200000": 1,
            "1642896000000": 1,
            "1643500800000": 1,
            "1644105600000": 1,
            "1644710400000": 1,
            "1645315200000": 2,
            "1645920000000": 2,
            "1646524800000": 1,
            "1647129600000": 1,
            "1647734400000": 1,
            "1648339200000": 1,
            "1648944000000": 1,
            "1649548800000": 1,
            "1650153600000": 1,
            "1650758400000": 1,
            "1651363200000": 1,
            "1651968000000": 1,
            "1652572800000": 1,
            "1653177600000": 1,
            "1653782400000": 1,
            "1654387200000": 1,
            "1654992000000": 1,
            "1655596800000": 1,
            "1656201600000": 1,
            "1656806400000": 1,
            "1657411200000": 2,
            "1658016000000": 1,
            "1658620800000": 1,
            "1659225600000": 1,
            "1659830400000": 2,
            "1660435200000": 1,
            "1661040000000": 1,
            "1661644800000": 1,
            "1662249600000": 1,
            "1662854400000": 1,
            "1663459200000": 1,
            "1664064000000": 1,
            "1664668800000": 1,
            "1665273600000": 1,
            "1665878400000": 1,
            "1666483200000": 1,
            "1667088000000": 1,
            "1667692800000": 2,
            "1668297600000": 2,
            "1668902400000": 1,
            "1669507200000": 1,
            "1670112000000": 1,
            "1670716800000": 1,
            "1671321600000": 1,
            "1671926400000": 1,
            "1672531200000": 1,
            "1673136000000": 0,
            "1673740800000": 1,
            "1674345600000": 1,
            "1674950400000": 1,
            "1675555200000": 1,
            "1676160000000": 1,
            "1676764800000": 1,
            "1677369600000": 1,
            "1677974400000": 1,
            "1678579200000": 1,
            "1679184000000": 3,
            "1679788800000": 2,
            "1680393600000": 5,
            "1680998400000": 1,
            "1681603200000": 1,
            "1682208000000": 1,
            "1682812800000": 1,
            "1683417600000": 1,
            "1684022400000": 1,
            "1684627200000": 1,
            "1685232000000": 1,
            "1685836800000": 1,
            "1686441600000": 2,
            "1687046400000": 1,
            "1687651200000": 1,
            "1688256000000": 1,
            "1688860800000": 1,
            "1689465600000": 1,
            "1690070400000": 1,
            "1690675200000": 2,
            "1691280000000": 1,
            "1691884800000": 1,
            "1692489600000": 4,
            "1693094400000": 1,
            "1693699200000": 1,
            "1694304000000": 1,
            "1694908800000": 1,
            "1695513600000": 1,
            "1696118400000": 1,
            "1696723200000": 1,
            "1697328000000": 1,
            "1697932800000": 1,
            "1698537600000": 1,
            "1699142400000": 1,
            "1699747200000": 1,
            "1700352000000": 1,
            "1700956800000": 1,
            "1701561600000": 1,
            "1702166400000": 1,
            "1702771200000": 1,
            "1703376000000": 1,
            "1703980800000": 1,
            "1704585600000": 1,
            "1705190400000": 2,
            "1705795200000": 2,
            "1706400000000": 1,
            "1707004800000": 2,
            "1707609600000": 2,
            "1708214400000": 1,
            "1708819200000": 2,
            "1709424000000": 2,
            "1710028800000": 1,
            "1710633600000": 2,
            "1711238400000": 2,
            "1711843200000": 1,
            "1712448000000": 1,
            "1713052800000": 2,
            "1713657600000": 1,
            "1714262400000": 1,
            "1714867200000": 1,
            "1715472000000": 1,
            "1716076800000": 1,
            "1716681600000": 4,
            "1717286400000": 1,
            "1717891200000": 1,
            "1718496000000": 1,
            "1719100800000": 3,
            "1719705600000": 2,
            "1720310400000": 9,
            "1720915200000": 100,
        }
    else:
        params = {
        "engine": "google_trends",
        "q": person,
        "geo": "ES",
        "date": "today 5-y",
        "tz": "420",
        "data_type": "TIMESERIES",
        "api_key": os.environ.get("SERPAPI_API_KEY")
        }

    search = GoogleSearch(params)
    results = search.get_dict()
    interest_over_time = results["interest_over_time"]

    result = {}
    for item in interest_over_time["timeline_data"]:
        timestamp = str(int(item["timestamp"]) * 1000)
        value = item["values"][0]["extracted_value"]
        result[timestamp] = value
        
    return result